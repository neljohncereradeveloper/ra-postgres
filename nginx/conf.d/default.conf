# ====================================================================
# Upstream Definitions
# Defines named groups of backend servers for load balancing.
# ====================================================================

# Upstream group for the web frontend application replicas.
upstream web_frontend {
    # Nginx will resolve 'web' using Docker's internal DNS to find the IPs
    # of the web service containers and load balance across them.
    # Connects to the internal port 3000 of the web containers.
    server web:3000;
}

# Upstream group for the server/API backend application replicas.
upstream server_backend {
    # Nginx will resolve 'server' using Docker's internal DNS.
    # Connects to the internal port 5670 of the server containers.
    server server:5670;
}

# ====================================================================
# Main Server Block
# Handles incoming requests on port 80 for the specified server name.
# ====================================================================
server {
    # Listen on port 80 for incoming HTTP requests.
    listen 80;
    # Respond to requests for this specific IP address.
    # Use your actual domain name here in production.
    server_name 10.128.1.241;
    
    # --- Logging --- 
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    # --- Real IP Module Configuration --- 
    # Since Nginx is behind Docker Desktop's proxy, the direct connection
    # will be from the Docker network gateway.
    # This configuration attempts to extract the original client IP
    # from the X-Forwarded-For header, but this often doesn't work
    # reliably in Docker Desktop due to its networking implementation.
    # In production (native Linux Docker), this should work correctly.
    set_real_ip_from 172.20.0.0/16; # Trust connections from our Docker network
    real_ip_header X-Forwarded-For;  # Header to check for the real IP
    real_ip_recursive on;           # Process the header fully if multiple IPs exist

    # --- Client Request Settings --- 
    # Maximum allowed size of the client request body.
    client_max_body_size 20M;
    # Settings for handling large client header buffers.
    large_client_header_buffers 4 16k;
    client_header_buffer_size 4k;

    location /ws/ {
        proxy_pass http://server_backend/;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    # ====================================================================
    # API Backend Proxy Location
    # Routes requests starting with /api/v1/ to the server_backend upstream.
    # ====================================================================
    location /api/v1/ {
        # Pass the request to the server_backend upstream group.
        proxy_pass http://server_backend;

        # --- Proxy Headers --- 
        # Pass essential headers to the backend application.
        proxy_set_header Host $host; # Pass the original Host header
        # Pass the IP Nginx sees as client (after real_ip module) as X-Real-IP.
        proxy_set_header X-Real-IP $remote_addr;
        # Append Nginx's view of the connecting IP to any existing X-Forwarded-For.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Inform the backend if the original request was HTTP or HTTPS.
        proxy_set_header X-Forwarded-Proto $scheme;

        # --- Proxy Timeouts & Version --- 
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;
        send_timeout 90s;
        proxy_http_version 1.1; # Use HTTP/1.1 for upstream connections
    }

    # ====================================================================
    # Web Frontend Proxy Location (Catch-All)
    # Routes all other requests (not matching /api/v1/) 
    # to the web_frontend upstream.
    # ====================================================================
    location / {
        # Pass the request to the web_frontend upstream group.
        proxy_pass http://web_frontend;

        # --- Proxy Headers --- 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # --- Proxy Timeouts & Version --- 
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;
        send_timeout 90s;
        
        # --- Proxy Buffering --- 
        # Buffering is often turned off for applications involving long-polling
        # or server-sent events to ensure real-time data flow.
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

 
}

